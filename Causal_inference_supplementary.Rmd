---
title: "Supplementary information for Manuscript titled Kin selection and sexual conflict influence the duration of breastfeeding  - considerations for causal inference"
output:
  bookdown::pdf_document2: default
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(rethinking)
library(dagitty)
library(truncnorm)
library(survival)
library(coxme)
library(tidyverse)
library(knitr)
library(arsenal)


#load and process real data
Feeding <-read.csv("breastfeeding_data.csv",header=TRUE)
Feeding<-read.csv("breastfeeding_data.csv",header=TRUE)
Feeding<- Feeding[complete.cases(Feeding),]
colnames(Feeding) [which (colnames(Feeding) == "kids")] <- 'child'
for (i in c(1:8,10) ) {
  Feeding[,i] <- as.factor(Feeding[,i])
}
Feeding$PMR <- relevel(Feeding$PMR, ref = "Patri")
col_realhh <- ifelse(Feeding$PMR == "Duo", "lightgreen", ifelse(Feeding$PMR == "Matri", "indianred", ifelse(Feeding$PMR == "Neo", "goldenrod", "lightblue")))
Feeding$District <- ifelse(Feeding$District == 1, "ZhaBa", 
                           ifelse(Feeding$District == 2, "LuGu", 
                           ifelse(Feeding$District == 3, "ZhuoNi", 
                           ifelse(Feeding$District == 4, "MaQu", "ShangriLa"))))
Feeding$PMR <- ifelse(Feeding$PMR == "Patri", "Patrilocal", 
                           ifelse(Feeding$PMR == "Matri", "Matrilocal", 
                           ifelse(Feeding$PMR == "Duo", "Duolocal", "Neolocal")))
#1 neolocal
#2 duolocal
#3 matrilocal
#4 patrilocal


```


The following document relates on the issue to causal inference by the correlation between relevant variables generated by genetic relatedness and on the strategies employed to address this issue.

# Genetic relatedness and why it can cause problems to causal inference 
\label{genetic_rel}

The present paper leverages genetic relatedness of individuals within a household as a measure of their bargaining power to define breastfeeding duration, i.e. their ability to define how long should a child be breastfed according to their (fitness) interests. We consider genetic relatedness of each focal child and that of their parents to the rest of the household. 

As described in the main text, we posit that the child's interest is to prolong breastfeeding as long as possible, as breastfeeding is associated to better health outcomes. Parents, on the contrary should prefer a shorter breastfeeding duration in order to move on to produce a new offspring, creating the conditions for a parent-offspring conflict. But the parents themselves have different investment in the length of the duration, which per se generates intersexual conflict. In particular, the mother is expected to prefer a longer breastfeeding duration, as females are expected to invest more in each offspring, while men should prefer shorter duration, as they have an interest in increasing the number of offspring rather than the quality. Additionally, social conditions and labour requirements at the household level influence breastfeeding duration, as breastfeeding women cannot engage in several productive activities or have limited labour outputs (reduced hours of work, reduced production per hour). We hence expect that in households where the mother has higher average relatedness to the rest of the members, these are more likely to cover for her missing labour and thus favour longer breastfeeding duration compared to households where the father has higher relatedness.

As mentioned, this approach hinges on using on the average relatedness level of children and parents to the household as a predictor of breastfeeding duration, which creates problems for causal inference, as the genetic relatedness of parents and offspring is tightly correlated by mechanisms of genetic inheritance. Because offspring inherit half of the chromosomes from each parent, children are always 0.5 related to each of their parents. The relation between the average relatedness to the whole household of children and parents, then, depends on the structure of the household itself. In a case limit where the household is composed by only a child and their unrelated parents, the relatedness of the parents to the rest of the household is $\frac{0.5 + 0}{2} = 0.25$, as each parent shares half of their genome with their child and none with the partner. The child shares half of their genome with each parent, making the child's relatedness simply the sum of their parent's relatednesses $0.25 + 0.25 = 0.5$. But parents can also be related to each other, and as the number of the member of a household increases, the average genetic relatedness of a child to the rest of the household approximates the sum of the relatedness of the parents divided by two ($\frac{relatednessMother + relatednessFather}{2} = relatednessChild$, for example in the limit case where there is an infinite number of siblings of the focal child, each related 0.5 to both the parents and the focal child). 

Differences in household composition and in relatedness between the parents (who can be cousins, for example) generate variation in the ratio of parents' and children's relatedness. The area of western China where data was collected offers just such variation, as there coexist multiple ethnic groups who differ in preferred residence patterns. Moreover, not all households within an ethnic group follow the mainstream residence type. This creates a reasonable amount of variation between and within ethnic group in choice of residence (i.e. duolocal, matrilocal, neolocal or patrilocal). The resulting variability in how related are individuals within a household (see figure 1, main text) can be leveraged for the statistical analysis. Table \ref{tab:relatedness} reports average relatedness between Mothers, Fathers and Children and the rest of their households by residence type (at the household level). 

<!-- |     Average relatedness to the household    |           Duolocal (N=161)         |          Matrilocal (N=119)        |            Neolocal \ (N=88)          |          Patrilocal \ (N=207)        | -->
<!-- |:-------------------------------------------:|:------------------------------------:|:------------------------------------:|:-------------------------------------:|:------------------------------------:| -->
<!-- |          Mother \ Mean (SD) \ Range         |      0.398 (0.091) \ 0.070 - 0.500    |      0.349 (0.081) \ 0.080 - 0.500     |     0.301 (0.099) \ 0.050  - 0.500    |      0.217 (0.086) \ 0.050 - 0.500  | -->
<!-- |          Father \ Mean (SD) \ Range         |     0.064 (0.121) \ 0.000 - 0.438    |     0.214 (0.117) \ 0.000 - 0.438    |      0.294 (0.128) \ 0.000 - 0.500    |     0.375 (0.077) \ 0.000 - 0.583       | -->
<!-- |          Child  \ Mean (SD) \ Range         |      0.319 (0.085) \ 0.160-0.500     |      0.370 (0.084) \ 0.160 - 0.500     |      0.401 (0.094) \ 0.170 - 0.500    |     0.385 (0.083) \ 0.130 - 0.500    | -->


```{r table_relatedness, results='asis'}
table_rel <- tableby(PMR ~  mother+child+father, data=Feeding, test=FALSE)
labels(table_rel) <- c(mother = "Mother", child = "Child", father = "Father")

summary(table_rel, digits = 2)
```

Table \ref{tab:relatedness}  - Average relatedness of mothers, fathers and children to other household members \label{tab:relatedness}


However, the significant correlation between parents' and children's relatedness can generate problems for causal inference and requires careful consideration. We thus develop a workflow that aims on the one hand to define a causal inference strategy for causal effects of relatedness on breastfeeding duration. On the other hand, we attempt to address in a principled way how predictions driven by competing hypotheses manifest themselves in the data, controlling for the risk of equifinality. 
We begin by using Direct Acyclic Graphs (DAGs) as a tool to illustrate causal connections between the relevant variables (see next section). This is helps in one hand to construct statistical models that are able to produce the correct inference to understand the effect of the relevant variables (i.e. define causal queries and choose the appropriate control sets), but also as a lead to build simulations. The use of simulations is helpful in this case to guide our intuition on what can the statistical models tell us about the _real_ effects of genetic relatedness. Because of the correlation in genetic relatedness, we could observe the phenomenon of equifinality: different causal models can produce the same distribution in the data and thus be practically non-distinguishable in the real data (e.g. the model could estimate the same values for parameter relative to the effect of mother's relatedness if the causal effect came from _her_ relatedness or from that of her child). Simulating data according to realistic relatedness patterns and following different causal models allows us to observe in a controlled (simulated) setting _what_ the statistical models can tell us (i.e. which hypotheses are virtually indistinguishable in the real data), but also guide us in the interpretation of the results of the analyses on the real data. We present below i) the assumed causal structure between the relevant variables; ii) the construction and use of simulated data to understand our ability to make inferences from the real data; iii) the comparison between the results from the simulated and real data and how we can use the first for our inferences with respect to the second; iv) an inferential approach that uses simulations to estimate the generative process for the real data, and associates it to one of the hypotheses.  



# Inferred causal structure

We first describe all the variables considered in the analysis and ways by which they influence the outcome, before describing the causal inference strategy we used.

## Description of variables


* Stop feeding: this is our outcome variable. It is the age at which the child was not breastfed anymore. Figure \@ref(fig:duration-data)  shows the duration of breastfeeding in our sample. The majority of mothers wean within the first 12 months (`r round(sum(Feeding$AgeStopFeed <= 12, na.rm = TRUE) / nrow(Feeding), digits=2) * 100`%) and only `r round(sum(Feeding$AgeStopFeed > 24, na.rm = TRUE) / nrow(Feeding), digits=2) * 100`% takes longer than two years (although we can see a large variation by residence type, as only `r round(sum(Feeding$AgeStopFeed[which(Feeding$PMR=="Neolocal")] >24, na.rm = TRUE) / nrow(Feeding[which(Feeding$PMR=="Neolocal"),]), digits=2) * 100`% of mothers in neolocal households breastfeed after this time). Note that values corresponding to yearly marks are much more frequent than expected at random. This can reflect a real phenomenon, i.e. children are more likely weaned at round years, because of cultural reasons, for example. But it is more likely that people tend to answer to uncertain, time-related questions with round numbers (a phenomenon known as age-heaping when the question is 'how old are you'). At least in part to deal with these issues, the data used for this analysis has been censored at 2 years (i.e. number of months up to 24 during which each child was breastfed, not exclusively). Moreover, some of the data is censored because of time of observation: a mother of a fifteen months old child reports she is still breastfeeding, but we have no information on how long that will last.  



```{r duration-data, fig.cap = " a - Duration of breastfeeding in our sample. Note the heaping at values corresponding to yearly marks. b - Duration of breastfeeding by child relatedness, color coded by residence pattern.", fig.dim = c(10, 4) }
par(mfrow = c(1,2), mgp = c(1.5, 0.5, 0), mar = c(2.5, 2.5, 2, 1) + 0.1)

hist(Feeding$AgeStopFeed, main="a", xlab = "Breastfeeding duration in months", 60, col = "cornflowerblue", border = "cornflowerblue")
plot(Feeding$AgeStopFeed, Feeding$child, col = col_realhh, pch = 16, xlab = "duration in months", ylab = "child relatedness", main = "b")
legend(50, 0.28, c("Duolocal", "Matrilocal", "Neolocal",  "Patrilocal"), fill = c("lightgreen", "indianred", "goldenrod","lightblue"), border = c("lightgreen", "indianred", "goldenrod","lightblue"), box.col = "white")

```



* Child relatedness: one of the main predictors, estimated genetic relatedness of the focal child to the rest of their household given the reported family relations (parents are on average 0.5 related to their children, grandparents 0.25 and so on; the relatedness for the parents is similarly calculated). We expect longer duration of breastfeeding the higher the average genetic relatedness to the household, under the assumption that in a more related household the interests of the child (longer duration of breastfeeding) count more.

* Mother relatedness: see child relatedness for the calculation of this measure. The mother optimal breastfeeding duration is influenced by her cost in producing milk, her interest in her child's well-being and the opportunity cost of not doing something else

* Father relatedness: see child relatedness for the calculation of this measure. Fathers' interests are likely pointing to a shorter duration of breastfeeding, as he is expected to have a preference for having another baby sooner than the mother's preference (breastfeeding inhibits the lutheal cycle thus rendering women temporarily infertile). 


* Village: Data was collected across the Zhaba, Lugu, Zhuoni, Maqu, and Shangrila regions, each comprising numerous distinct villages. Village is used as a proxy for geographical/ecological differences between these groups and for ethnicity, which is linked to cultural practices and prevalent subsistence strategies that can influence breastfeeding duration. The prevalence of residence patterns varies in each region, see Table \ref{tab:descriptive}, for example Duolocality is prevalent in Zhaba and Lugu (58.6%  and 40.8% of households) and completely absent in Zhuoni, Maqu and Shangrila, the last of which is prevalently matrilocal (44.6%), while the remaining two are largely patrilocal (60 and 66.9% respectively).


* Residence pattern: one between duolocal (each parent remains within their natal household, relatedness of the mother is highest, lowest for the father), matrilocal (the couple lives with the wife's family, relatedness is high for the child and mother, low for the father), neolocal (the couple lives in a new household, relatedness is lower and similar for mother and father, high for the child) or patrilocal (the couple lives with the husband's family, father and child have high relatedness, lowest for the mother). We assume that any cultural effect linked to residence pattern is clustered at the level of village (ethnicity), rather than residence pattern.



* Household size: The people you live with can greatly influence the amount of assistance you receive; in some cases, it also determines the number of potential competitors you may face. Therefore, the size of the household is crucial for breastfeeding practices, as it is associated with the level of direct support (such as bottle-feeding infants) or indirect support (such as relieving the mother of household chores so she can focus on breastfeeding) that the mother can receive during her breastfeeding journey.
We categorized household size into 3 different types (small, medium and big), based on how many family members were living together in the same household. Small household with <= 4 family members, medium with 5-8 family members, and big with >8 family members.  This classification is in line with the categorization that we used in another paper with the same demographic database (Chen et al 2023). 


* Birth order: Siblings compete for family resources, a competition that begins from birth. For instance, if a mother breastfeeds one child for an extended period, it may delay her ability to have another baby. The intensity of this competition varies between full and half-siblings, as noted by Trivers in 1974. Parents might exhibit a preference for the older offspring, a phenomenon known as primogeniture, which has been documented in one of the populations from the same database (Du et al. 2023). However, parents may also show a preference for the youngest child, particularly in contexts where child policies reduce the likelihood of having more children.
In this paper we present this variable as either 1st born or >=2nd born. This is because we only included births after 2010 (to improve accurate recalling of breastfeeding information), by which point the area was interested by a fully implemented child policy (a maximum of 3 children per woman in this area). As a result, our data include only 4 births of a 3rd child, which were thus classified together with 2nd borns. 

* Child sex: Parents exhibit gender-biased parental investment, with preferences that vary according to ecological and social norms. In one of our studied populations, we have previously demonstrated that mothers tend to breastfeed daughters longer than sons (Du & Mace 2018). However, the patterns of gender-biased investment across five different populations remain unclear. To address this, we controlled for the gender of the offspring in our analysis, categorizing them into two groups: daughters/females and sons/males.

<!-- * Mother age: Maternal age is a significant factor in determining breastfeeding practices. A study by Manyeh et al. (2020) reveals that mothers aged 25–29 and those aged 30 years and above are respectively 93% and 91% more likely to engage in exclusive breastfeeding for six months compared to mothers younger than 20 years. In our dataset, we observe that women often begin childbearing and breastfeeding at a relatively young age. Therefore, we have categorized the mothers' ages at the time of childbirth into three age groups: under 20 years, 20-25 years, and over 25 years. -->

* Mother cohort: the middle and latter half of the 20th century saw a gradual decline of breastfeeding, which was replaced by formula feeding in many high income contexts (Tomori et al., 2016). We controlled for mother birth time at 10 years cohort, which could capture how globalization influences the norm and the practices of feeding. In addition, several political factors might also influence the feeding practices, for example, child policy that was implemented in the early 1980s, and the compulsory education policy that was implemented at 1990s. We thus categorized mother birth into 10 years cohort:  <=1980, 1980-1989 to >=1990

* Physical constraints: physical problems are one of the important reasons for terminating breastfeeding (Verronen, 1982; Page et al 2021), i.e. sore and cracked nipples, painful breasts and poor latching et al (Li et al., 2008) are commonly reported as important problems and act as a barrier to continued breastfeeding.  Detailed data on physical constraints was unfortunately not available for this analysis.  

* Household wealth: higher household wealth is expected to be associated with longer breastfeeding if mothers' labour is needed in poorer households, or shorter if alternative food sources are a limiting factor for weaning. Detailed data on household wealth was unfortunately not available for this analysis. 




<!-- |                                |           Zhaba          |           Lugu          |           Zhuoni        |            Maqu          |      Shangrila           |           Total          | -->
<!-- |:------------------------------:|:------------------------:|:-----------------------:|:-----------------------:|:------------------------:|:------------------------:|:------------------------:| -->
<!-- |             **N**              |             203          |            103          |             65          |             121          |             83           |             575         | -->
<!-- |             **PMR       **     |                          |                         |                         |                          |                          |                          | -->
<!-- |              Duolocal          |       119   (58.6%)      |       42   (40.8%)      |       0      (0.0%)     |       0      (0.0%)      |         0   (0.0%)       |       161   (28.0%)      | -->
<!-- |             Matrilocal         |        28   (13.8%)      |       11   (10.7%)      |       10   (15.4%)      |        33   (27.3%)      |        37   (44.6%)      |       119   (20.7%)      | -->
<!-- |              Neolocal          |        30   (14.8%)      |       19   (18.4%)      |       16   (24.6%)      |       7      (5.8%)      |        16   (19.3%)      |        88   (15.3%)      | -->
<!-- |             Patrilocal         |        26   (12.8%)      |       31   (30.1%)      |       39   (60.0%)      |        81   (66.9%)      |         30 (36.1%)       |       207   (36.0%)      | -->
<!-- |     **Mother Birth cohort   ** |                          |                         |                         |                          |                          |                          | -->
<!-- |                <1980           |        13   (6.4%)       |        10   (9.7%)      |       5      (7.7%)     |       3      (2.5%)      |       1      (1.2%)      |       32      (5.6%)     | -->
<!-- |               >=1990           |       139   (68.5%)      |       57   (55.3%)      |       28   (43.1%)      |        60   (49.6%)      |        55   (66.3%)      |       339   (59.0%)      | -->
<!-- |              1980-1989         |        51   (25.1%)      |       36   (35.0%)      |       32   (49.2%)      |         58 (47.9%)       |        27   (32.5%)      |       204   (35.5%)      | -->
<!-- |      **Child Birth Order   **  |                          |                         |                         |                          |                          |                          | -->
<!-- |                 1st            |       111   (54.7%)      |       39   (37.9%)      |       20   (30.8%)      |        51   (42.1%)      |        57   (68.7%)      |       278   (48.3%)      | -->
<!-- |                >=2nd           |        92   (45.3%)      |       64   (62.1%)      |       45   (69.2%)      |        70   (57.9%)      |        26   (31.3%)      |       297   (51.7%)      | -->
<!-- |        **Household Size   **   |                          |                         |                         |                          |                          |                          | -->
<!-- |                 Big            |        72   (35.5%)      |        33 (32.0%)       |       20   (30.8%)      |        32   (26.4%)      |        30   (36.1%)      |       187   (32.5%)      | -->
<!-- |               Medium           |       111   (54.7%)      |       62   (60.2%)      |       44   (67.7%)      |        49   (40.5%)      |        50   (60.2%)      |       316   (55.0%)      | -->
<!-- |                Small           |        20   (9.9%)       |       8      (7.8%)     |       1      (1.5%)     |        40   (33.1%)      |       3      (3.6%)      |        72   (12.5%)      | -->
<!-- |       **Feeding   Duration **  |                          |                         |                         |                          |                          |                          | -->
<!-- |              Mean (SD)         |     16.04   (12.57)      |     14.58   (8.86)      |      7.31   (6.36)      |     19.38   (19.78)      |      7.95   (3.15)       |     14.33   (13.23)      | -->
<!-- |                Range           |         0  - 60          |          0 - 48         |          1 - 36         |           0 - 72         |          1 - 14         |            0 - 72         | -->
<!-- |      **Mother Relatedness   ** |                          |                         |                         |                          |                          |                          | -->
<!-- |              Mean (SD)         |       .372 (.105)        |      .305 (.100)        |        .201 (.078)      |        .273 (.100)       |      .288 (.115)     |      .308 (.116)             | -->
<!-- |                Range           |      .100 - .500         |      .070 - .500        |      .060 - .440        |      .070 - .500         |      .050 - .420     |      .050 - .500             | -->
<!-- |     **Child   Relatedness   ** |                          |                         |                         |                          |                          |                          | -->
<!-- |              Mean (SD)         |      .348 (.084)         |      .412 (.096)        |      .315 (.078)        |      .396 (.098)         |      .351 (.054)     |      .366 (.091)             | -->
<!-- |                Range           |      .130 - .500         |      .160 - .500        |      .160 - .500        |      .130 - .500         |      .200 - .500     |      .130 - .500             | -->
<!-- |      **Father Relatedness   ** |                          |                         |                         |                          |                       |                             | -->
<!-- |              Mean (SD)         |      .150 (.181)         |      .267 (.162)        |      .321 (.137)        |      .326 (.094)         |      .258 (.124)     |      .243 (.167)             | -->
<!-- |                Range           |      .000 - .650         |      .000 - .438        |      .050 - .583        |      .000 - .438         |      .000 - .417     |      .000 - .650             | -->


```{r table_descriptive, results='asis'}
#to make this print, change resutls to 'asis
table3 <- tableby(District ~ PMR+ BirthPeriod +order + Csex +
                          + HSCAT +AgeStopFeed+ mother+child+father+time + status, data=Feeding, test=FALSE)[1:9]
labels(table3) <- c(District = "District", PMR = "Residence", BirthPeriod = "Cohort", order = "Birth order", Csex = "Gender", HSCAT = "Household", AgeStopFeed = "Duration", mother = "Mother", child = "Child", father = "Father")
summary(table3, digits = 2)
```

SI Table \ref{tab:descriptive}: Descriptive statistics by ethnic group. \label{tab:descriptive}

## A digression on causes for weaning

In order to correctly frame the hypotheses, it is worth having a look at some information on the causes women adduce for stopping breastfeeding. Across the populations, the majority of causes are relative to social norms or opportunity costs (27% and 36% respectively, table \ref{tab:reasons2}). But once we split by residence pattern, opportunity cost becomes a much more prominent cause in patrilocal households (57%, see table 4 in main text).



| category         | Reasons for weaning                                                             | count | total ( % ) |
|------------------|---------------------------------------------------------------------------------|-------|-------------|
| Physical costs   | Mastitis                                                                        | 1     | 7 ( 16 % )  |
|                  | Constantly ill                                                                  | 2     |             |
|                  | Sterilization surgery                                                           | 1     |             |
|                  | Not enough breast milk                                                          | 3     |             |
| Social norm      | I heard that the breast milk has become clear , lacking fat                     | 1     | 12 ( 27 % ) |
|                  | Family members say that the breast milk is no longer nutritious                 | 3     |             |
|                  | The child keeps crying because the milk is not good                             | 1     |             |
|                  | Several of my friends weaned their children at this time                        | 3     |             |
|                  | If the feeding time is too long, it's not easy to wean                          | 1     |             |
|                  | Most people around me wean at this time                                         | 3     |             |
| Opportunity cost | It's too time-consuming, I can't do long-distance work                          | LD 6  | 16 ( 36 % ) |
|                  | Frequent breastfeeding can lead to breast engorgement , affecting farm work     | 2     |             |
|                  | Can't go out to work                                                            | 5     |             |
|                  | Went to help with work at my sister's house for a while                         | 1     |             |
|                  | Went off to work                                                                | 2     |             |
| Other            | The child sleeps with the grandmother, so he / she doesn't eat my breastmilk    | 1     | 9 ( 20 % )  |
|                  | The child refuses to eat                                                        | 5     |             |
|                  | Stopped breastfeeding after getting pregnant with the second child              | 2     |             |
|                  | I don't want to breastfeed                                                      | 1     |             |

SI Table \ref{tab:reasons2}: Coded reasons for weaning, details. \label{tab:reasons2}




<!-- |     Category             |     Neolocal    |     Patrilocal    |     Matrilocal    | -->
<!-- |--------------------------|-----------------|-------------------|-------------------| -->
<!-- |     physical costs       |     3 (19%)     |     2(14%)        |     2(14%)        | -->
<!-- |     opportunity costs    |     5(31%)      |     8(57%)        |     3(21%)        | -->
<!-- |     social norms         |     4(25%)      |     2(14%)        |     6(43%)        | -->
<!-- |     others               |     4(25%)      |     2(14%)        |     3(21%)        | -->

<!-- SI Table \ref{tab:reasons1}: Coded reasons for weaning, split by three different post marital residence. \label{tab:reasons1} -->

## Direct Acyclic Graph and causal inference strategy

Our causal inference strategy relies on estimating the relative effects of children's and parents' relatedness on breastfeeding duration. We considered a set of covariates that could influence the results, as described in the previous section. According to our proposed causal structure, shown in Figure \@ref(fig:dag), a minimum set of controls for correctly estimating the direct effects of individuals' relatedness include only village, household size and mother's cohort in addition to our estimands. We also control for sex of child, birth order of child, cohort of mothers and random effects for mothers' IDs, which help the estimate. The linear regression for the cox model 3 used to report the results of the effect of individual's relatedness on breastfeeding duration includes as predictors: child relatedness, mother relatedness, father relatedness, sex of child, household size, child birth order, cohort of mother, village and mothers' IDs as random effects.  



In order to estimate the total effect of residence pattern on breastfeeding duration, model 2, which summarizes the separate effects of the various relatedness structures, the minimum adjustment set (i.e. which control variables need to be considered to obtain a reliable causal inference) includes only village, to which we add sex of child, birth order of child, cohort and random IDs for mothers, to increase the precision of the estimate. The linear regression for the cox model used to report the results of the effect of residence pattern on breastfeeding duration includes as predictors: residence pattern, sex of child, child birth order, cohort of mother, village and mothers' IDs as random effects.    

The following section will help elucidate why these models are appropriate for testing the predictions for the hypotheses considered and provide additional material for inference.

```{r dag, fig.cap='DAG illustrating the variables considered in our analysis and the causal connections between them. See the text for details.'}
knitr::include_graphics("../DAG.pdf")
```

<!-- ```{r dag, fig.cap = "DAG illustrating the variables considered in our analysis and the causal connections between them. See the text for details.", fig.dim = c(6, 4)} -->
<!-- DAG1 <- dagitty('dag { -->
<!-- "birth order" [pos="1.3,-0.7"] -->
<!-- "child relatedness" [exposure,pos="-0,1.5"] -->
<!-- "child sex" [pos="1,-1.3"] -->
<!-- "father relatedness" [pos="0.8,0.8"] -->
<!-- "household size" [pos="-1.5,0"] -->
<!-- "U" [pos="1.5,0"] -->
<!-- "mother cohort" [pos="-0,-1.5"] -->
<!-- "mother relatedness" [pos="-0.8,0.8"] -->
<!-- "village" [pos="-1,-1.3"] -->
<!-- "residence pattern" [pos="-1.3,-0.7"] -->
<!-- "stop feeding" [outcome,pos="-0,-0"] -->
<!-- "birth order" -> "stop feeding" -->
<!-- "child relatedness" -> "stop feeding" -->
<!-- "child sex" -> "stop feeding" -->
<!-- "father relatedness" -> "child relatedness" -->
<!-- "father relatedness" -> "stop feeding" -->
<!-- "household size" -> "child relatedness" -->
<!-- "household size" -> "father relatedness" -->
<!-- "household size" -> "mother relatedness" -->
<!-- "household size" -> "stop feeding" -->
<!-- "U" -> "stop feeding" -->
<!-- "mother cohort" -> "stop feeding" -->
<!-- "mother relatedness" -> "child relatedness" -->
<!-- "mother relatedness" -> "stop feeding" -->
<!-- "residence pattern" -> "child relatedness" -->
<!-- "residence pattern" -> "father relatedness" -->
<!-- "residence pattern" -> "household size" -->
<!-- "residence pattern" -> "mother relatedness" -->
<!-- "village" -> "residence pattern" -->
<!-- "village" -> "stop feeding" -->
<!-- } -->
<!-- ') -->
<!-- plot(DAG1) -->
<!-- ``` -->


## Hypotheses and causal models


While we believe that the statistical models presented above report the correct estimates for our predictors, the causal interpretation of these estimates require careful consideration. In particular, because of the genetic mechanism correlating children's and parent's relatedness to the rest of the family, we aimed at improving our ability to parse out between different predictions associated to the hypotheses. We recur to the use of simulations to address the problem of equifinality and better understand how different cox models are able to pick up on the differences between data associated to generative causal models.

We start by reviewing the main hypotheses, the causal models associated to these hypotheses, i.e. the expected directions of the effects of the variable, and the reasons why it can be difficult to compare them, before moving on to simulation, testing and interpretation.
 

*Parent-offspring conflict:* We expect child relatedness to have a positive effect on the duration of breastfeeding, while parents' would have a negative effect. 

*Sexual conflict:* We expect mothers' relatedness to have a positive effect on the duration of breastfeeding, while father's would have a negative effect

This would result longer breastfeeding expected in households where the child has higher than average relatedness and shorter where the father has higher relatedness. However, intermediate duration is consistent with both hypotheses, as we can see when we simulate them.

## Full results from cox models

Here we report estimated Hazard ration for the three main cox linear regression models.

<!-- |                  　                |     Model 1 (control)    |                 |     Model 2 (Residence effects)    |                 |     Model 3 (Relatedness)    |                 | -->
<!-- |:----------------------------------:|:------------------------:|:---------------:|:----------------------------------:|:---------------:|:----------------------------:|:---------------:| -->
<!-- |                  　                |             HR           |         P       |                  HR                |         P       |               HR             |         P       | -->
<!-- |    **Child sex (ref:Daughter)**    |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                     Son            |           1.200          |       0.160     |                1.251               |       0.083     |             1.219            |       0.130     | -->
<!-- |   **Child birth order (ref:1st)**  |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                   >=2nd            |           1.037          |       0.770     |                1.033               |       0.800     |             1.081            |       0.540     | -->
<!-- |      **Family size(ref:Big)**      |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                  Medium            |           0.504          |       0.000     |                0.512               |       0.000     |             0.596            |       0.004     | -->
<!-- |                   Small            |           0.438          |       0.003     |                0.408               |       0.001     |             0.675            |       0.190     | -->
<!-- | **Mother birth cohort(ref:<1980)** |                          |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                1980-1989           |           1.078          |       0.840     |                1.107               |       0.780     |             1.083            |       0.830     | -->
<!-- |                  >=1990            |           1.331          |       0.430     |                1.465               |       0.290     |             1.302            |       0.460     | -->
<!-- |      **PMR (ref: Patrilocal)**     |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                  Duolocal          |             　           |        　       |                0.374               |       0.000     |               　             |        　       | -->
<!-- |                 Matrilocal         |             　           |        　       |                0.745               |       0.190     |               　             |        　       | -->
<!-- |                  Neolocal          |             　           |        　       |                0.578               |       0.032     |               　             |        　       | -->
<!-- |          Child  relatedness        |             　           |        　       |                  　                |        　       |             0.034            |       0.006     | -->
<!-- |         Mother   relatedness       |             　           |        　       |                  　                |        　       |             0.438            |       0.420     | -->
<!-- |         Father   relatedness       |             　           |        　       |                  　                |        　       |             4.593            |       0.046     | -->
<!-- |                  　                |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |        **Random   effects**        |             　           |        　       |                  　                |        　       |               　             |        　       | -->
<!-- |                Group               |             SD           |     Variance    |                  SD                |     Variance    |               SD             |     Variance    | -->
<!-- |         Village/Mother   ID        |           1.023          |       1.046     |                1.039               |       1.079     |             1.034            |       1.068     | -->
<!-- |               Village              |           0.560          |       0.314     |                0.277               |       0.077     |             0.363            |       0.132     | -->
```{r coxresults}
#run all models (1-3 plus single family members)
#Model 2 with residence type
residence_real<-coxme(Surv(time,status)~PMR+Csex+order+HSCAT+ BirthPeriod+(1|Village/ITID)
           ,data = Feeding) 
        
#Model 3 with predictors for all family members
all_real<- coxme(Surv(time,status)~child+mother+father+Csex+order+HSCAT+BirthPeriod+(1|Village/ITID)
            ,data = Feeding)  

#Model 1 with only controls
control_real<- coxme(Surv(time,status)~Csex+order+HSCAT+BirthPeriod+(1|Village/ITID)
                ,data = Feeding) 

mother_real<-coxme(Surv(time,status)~mother+Csex+order+HSCAT+BirthPeriod+(1|Village/ITID)
              ,data = Feeding) 

child_real<-coxme(Surv(time,status)~ child + Csex+order+HSCAT+BirthPeriod+ (1|Village/ITID)
             ,data = Feeding)
father_real <-coxme(Surv(time,status)~father+Csex+order+HSCAT+BirthPeriod+(1|Village/ITID)
           ,data = Feeding)
parents_real <- coxme(Surv(time,status)~mother+father+Csex+HSCAT+order+BirthPeriod+(1|Village/ITID)
                ,data = Feeding) 

#CREATE TABLE WITH Hazard ratios and p values
hazard_ratios <- matrix(nrow = 12, ncol = 3, dimnames = list( c("Son (vs daughter)", "2nd (vs 1st) child", "Medium size (vs. big)", "Small size (vs. big)", "Mother cohort >=1990 (vs. <1980)", "Mother cohort 1980-89 (vs. <1980)", "Duolocal (vs. Patrilocal)", "Matrilocal (vs. Patrilocal)", "Neolocal (vs. Patrilocal)", "Child relatedness", "Mother relatedness", "Fahter relatedness") , c("Model 1 - HR (p value)", "Model 2 - HR (p value)", "Model 3 - HR (p value)")))
days_se<- sqrt(diag(vcov(control_real)))
days_coef<- fixef(control_real)
HR<- exp(days_coef)
p_val <- signif(1 - pchisq((days_coef/days_se)^2, 1), 2)
hazard_ratios[1:length(days_se),1] <- paste(round(HR, 2), " (", round(p_val, 2), ")", sep = "") 

days_se<- sqrt(diag(vcov(residence_real)))
days_coef<- fixef(residence_real)
HR<- exp(days_coef)
p_val <- signif(1 - pchisq((days_coef/days_se)^2, 1), 2)
hazard_ratios[1:6,2] <- paste(round(HR[4:9], 2), " (", round(p_val[4:9], 2), ")", sep = "") 
hazard_ratios[7:9,2] <- paste(round(HR[1:3], 2), " (", round(p_val[1:3], 2), ")", sep = "") 


days_se<- sqrt(diag(vcov(all_real)))
days_coef<- fixef(all_real)
HR<- exp(days_coef)
p_val <- signif(1 - pchisq((days_coef/days_se)^2, 1), 2)
hazard_ratios[1:6,3] <- paste(round(HR[4:9], 2), " (", round(p_val[4:9], 2), ")", sep = "") 
hazard_ratios[10:12,3] <- paste(round(HR[1:3], 2), " (", round(p_val[1:3], 2), ")", sep = "") 

hazard_ratios[which(is.na(hazard_ratios))] <- ""


kable (hazard_ratios, "pipe")
```
SI table \ref{tab:coxresults}: Results from Cox regression models predicting factors associated with likelihood of weaning, censored at two years old. Model 1: the Control model (accounting for child sex, child birth order, mother's birth cohort, and household size). Model 2: residence pattern effect, with control model plus post-marital residence. Model 3: includes, Control model plus child, mother and father’s average relatedness to other household members. The Hazard Ratio (HR) is indicated; a value greater than 1 suggests a higher likelihood of breastfeeding termination, while a value less than 1 indicates a lower likelihood. \label{tab:coxresults}



# Approach

## Simulate relatedness

```{r sim_function}
#function to simulate breastfeeding data
#note that the function needs a set of average relatednesses for the parents in each residence type (relatedness_averages), and a set of parameters for the poisson simulation (one value per each of four parameters for each considered hypothesis, within the list poiss_parameters)
#note that the function has the option to return the full set of data and model results, or only the coefficients estimated by the cox models
# note that there (WILL BE) the option to test with censoring
sim_breastfeeding <- function (N, relatedness_avg = relatedness_averages, poiss_pars = poiss_parameters, n_hyp = ncol(poiss_pars), censor = FALSE, censor_at = 12, coefficients = FALSE ){
  #generate household types and assign color
  #1 neolocal
  #2 duolocal
  #3 matrilocal
  #4 patrilocal
  household <- sample(1:4, N, replace = TRUE)
  col_hh <- ifelse(household == 1, "goldenrod", ifelse(household == 2, "lightgreen", ifelse(household == 3, "indianred", "lightblue")))
  
  #generate relatednesses 
  mom_rel <- ifelse(household == 1,rtruncnorm(n = N, a = 0.09, b = 0.50, mean = relatedness_avg$mom[3], sd = 0.10),
                    ifelse(household == 2, rtruncnorm(n = N, a = 0.07, b = 0.50, mean = relatedness_avg$mom[1], sd = 0.09),
                           ifelse(household == 3,rtruncnorm(n = N, a = 0.08, b = 0.55, mean = relatedness_avg$mom[2], sd = 0.09),
                                  rtruncnorm(n = N, a = 0.05, b = 0.50,mean = relatedness_avg$mom[4], sd = 0.09))))
  
  
  dad_rel <- ifelse(household == 1,rtruncnorm(n = N, a = 0.00, b = 0.50, mean = relatedness_avg$dad[3], sd = 0.13),
              ifelse(household == 2, rtruncnorm(n = N, a = 0.00, b = 0.43, mean = relatedness_avg$dad[1], sd = 0.12),
               ifelse(household == 3,rtruncnorm(n = N, a = 0.00, b = 0.44, mean = relatedness_avg$dad[2], sd = 0.11),
                                  rtruncnorm(n = N, a = 0.25, b = 0.65, mean = relatedness_avg$dad[4], sd = 0.08))))
  
  child_rel <- (mom_rel + dad_rel)/2 + rnorm(N, 0.1, 0.05)
  
  #generate duration of breastfeeding from poisson distribution
  poiss_rate <- matrix(nrow = N, ncol = n_hyp)
  duration <- matrix(nrow = N, ncol = n_hyp)
  status <- matrix(nrow = N, ncol = n_hyp)
  for (i in 1:n_hyp){
    poiss_rate[,i] <- exp( rnorm(N, poiss_pars[1,i], 0.2) + child_rel * poiss_pars[2,i] + mom_rel * poiss_pars[3,i] + dad_rel * poiss_pars[4,i])
  
    duration[,i] <- rpois(N, poiss_rate[,i]) 
  
    #generate status (i.e. whether data is censored)
    if(censor == FALSE) {
      status[,i] <-  rep(1, N)} else {
        status[,i] <- ifelse(duration[,i] > censor_at, 0, 1) }

        #censor to twelve months
    if(censor == TRUE){
      duration[,i] <- ifelse(duration[,i] >= censor_at, censor_at, duration[,i])
    }#if censor
  }#generate durations

  #run cox models
  child_sim <- list()
  mother_sim <- list()
  father_sim <- list()
  parents_sim <- list()
  all_sim <- list()
  residence_sim <- list()

  for( i in 1:n_hyp){
    child_sim[[i]] <- coxph(Surv(duration[,i], status[,i]) ~ child_rel)
    mother_sim[[i]] <- coxph(Surv(duration[,i], status[,i]) ~ mom_rel)
    father_sim[[i]] <- coxph(Surv(duration[,i], status[,i]) ~ dad_rel)
    parents_sim[[i]] <- coxph(Surv(duration[,i], status[,i]) ~ mom_rel + dad_rel)
    all_sim[[i]] <- coxph(Surv(duration[,i], status[,i]) ~ child_rel + mom_rel + dad_rel)
    residence_sim[[i]] <- coxph(Surv(duration[,i], status[,i])~as.factor(household))
    
  }#run cox model
  
  #prepare data
  #if we want all data output (coefficients is FALSE)
  breastfeeding_data <- list(N = N,
                             household = household,
                             col_hh = col_hh,
                             mom_rel = mom_rel,
                             dad_rel = dad_rel,
                             child_rel = child_rel,
                             poiss_rate = poiss_rate,
                             duration = duration,
                             status = status,
                             child_sim = child_sim,
                             mother_sim = mother_sim,
                             father_sim = father_sim,
                             parents_sim = parents_sim,
                             all_sim = all_sim,
                             residence_sim = residence_sim
                             )
  #if we want only the coefficients (for plotting, coefficients is TRUE)
  breastfeeding_coefficients <- list(child  = child_sim |> map("coefficients"), 
                                     mother = mother_sim |> map("coefficients"),
                                     father = father_sim |> map("coefficients"),
                                     parents = parents_sim |> map("coefficients"),
                                     all = all_sim |> map("coefficients"),
                                     residence = residence_sim |> map("coefficients"))
  #decide output (data or coefficients)
  if(coefficients == TRUE){
    return( breastfeeding_coefficients )
  } else {
    return( breastfeeding_data ) 
  }
  
}
```
 
We simulate N = 500 children and assign them to one of the four possible residence types (duolocal, matrilocal, neolocal and patrilocal). We then generate for each child the relatedness of the mother, father and child itself. The relatedness of the parents is sampled from normal distributions that match the real data for the four residence types (means of 0.4, 0.36, 0.3 and 0.22 for the mothers and 0.06, 0.22, 0.30 and 0.38 for fathers respectively, with a standard deviation around 0.1). For children, instead, we generate a relatedness level by summing the parents' relatedness and dividing by two (see SI section \ref{genetic_rel}) and add a ramdom value sampled from a Gaussian distribution with mean 0.1 and SD 0.05, which simulates variation in household structure within the residence pattern and brings the generated distribution closer to the observed distribution for children's relatedness by household (see SI Figure \@ref(fig:simulate-relatedness)). 
 
```{r simulate-relatedness, fig.cap = "Real distribution of relatedness (grey) and simulated relatedness (blue).", fig.dim = c(5, 4)}
#define average relatedness for parents
#the followinf is based on real data
relatedness_averages <- data.frame(mom = c(0.4, 0.36, 0.3, 0.22 ),
                              dad = c(0.06, 0.22, 0.3, 0.38))
#define coefficients for each hypothesis (see below for explanation on the coefficients)
n_hypotheses <- 4
poiss_parameters <- matrix(c( 3,  2,-2,-2, #H1
                             2.5, 0, 2,-2, #H2
                             1,4,2,-2, #H3
                             2, 2, 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE,
                     dimnames = list(c("intercept", "child", "mom", "dad"),
                                     c(paste(rep("H", n_hypotheses), 1:n_hypotheses, sep = ""))))
#simulates breastfeeding data and model results for four different hypotheses
bf <- sim_breastfeeding(N = 500)




par(mgp = c(1.5, 0.5, 0), mar = c(2.5, 2.5, 2, 1) + 0.1)
hist(bf$child_rel, border = "lightgrey", main = NULL, ylim = c(0,bf$N/3), xlab = "child relatedness", xlim = c(0.1, 0.7))
hist(Feeding$child, add = TRUE, col = col.alpha("cornflowerblue", 0.4), border = col.alpha("cornflowerblue", 0.4))
legend(0.1, 145, c("simulated", "real"), fill = c("lightgrey", col.alpha("cornflowerblue", 0.4)), border = c("lightgrey", col.alpha("cornflowerblue", 0.4)), box.col = "white")
```
 
## Generate simulated breastfeeding duration according to different causal models 

 
We then generate duration of breastfeeding from these genetic relatedness (simulated) data we sample from a Poisson distribution which rate $\lambda$ depends on a linear function of child and parent's relatedness (indicated in the equation below as $C, M \text{ and } D$ respectively). The parameters for the predictors $\beta, \gamma \text{ and } \delta$ are selected depending on the two main alternative hypotheses and possible other scenarios, including a combination of the two hypotheses (see SI table \ref{tab:hypotheses}).
 
 $$
 Duration \sim \mathrm{Poisson} (\lambda)
 $$
 $$
 \lambda = \alpha + \beta C + \gamma M + \delta D
 $$
 <!-- Causal models = causal structure + parameters -->
 
|    | Hypothesis                 | Child | Mother | Father |
|----|----------------------------|:-----:|:------:|:------:|
| H1 | Parents-offspring conflict |   +   |    -   |    -   |
| H2 | Gender conflict            |   0   |    +   |    -   |
| H3 | Both                       |   ++  |    +   |    -   |
| H4 | No effect of parents       |   +   |    0   |    0   |

SI Table \ref{tab:hypotheses}: hypotheses associated to causal models. \label{tab:hypotheses}

Note that the columns 'Child', 'Mother' and 'Father' indicate the expected direction of the effect for genetic relatedness as a predictor in the different hypotheses. According to the Parent offspring conflict hypothesis, the more a child is related to their household the longer they are breastfed, while it is the contrary for the parents, and so on.

SI Figure \@ref(fig:dots) shows simulated duration of breastfeeding according to the parameters associated to the causal models above. The points are colored depending on household type. 

 
```{r dots, fig.cap = "Simulated breastfeeding duration for four different hypotheses (causal models), color coded by residence pattern." }
par(mfrow = c(2,2),mgp = c(1.5, 0.5, 0), mar = c(2.5, 2.5, 2, 1) + 0.1)

for(i in 1:n_hypotheses){
        plot(bf$duration[,i], bf$child_rel, col = bf$col_hh, pch = 16, xlab = paste("duration - H", i, sep = ""), ylab = "child relatedness", xlim = c(0, 70))
}

legend(40, 0.42, c("Duolocal", "Matrilocal", "Neolocal",  "Patrilocal"), fill = c("lightgreen", "indianred", "goldenrod","lightblue"), border = c("lightgreen", "indianred", "goldenrod","lightblue"), box.col = "white")
```


## What can we learn about the causal model from simulations?

The first objective is to use our simulations based on different causal models to qualitatively evaluate which of the dataset generated by each causal model produces parameter estimates from the cox model that are the most similar to those generated by the real data. The second objective is to find a set of generative parameters for our simulation that generates data producing the most similar results (once the cox regressions are fit on them), and then compare this 'optimal parameters set' to our causal models. 

### Simulate data from causal models and compare results of simulated and real data

We start by running six combination of cox regression models on the real data (see SI table \ref{tab:statsmodels} to see which sets of predictors and covariates were included; the last two correspond to models 3 and 2 in the main text respectively). From these models we obtain multiple estimates for the effect of parental and child relatedness on the duration of breastfeeding (note that these effects are parameter estimates for the cox model, so that negative numbers mean a reduction of risk, and a positive effect on duration). 
We then run the same six cox model (including only the main predictors, as we did not simulate the covariates) on data simulated according to our causal models. This allows us, as a first step, to observe the ability of the cox models to qualitatively recover the effects of the main predictors and make inferences.


| model          | main predictors                                                       | covariates                                                           | panel |
|----------------|-----------------------------------------------------------------------|----------------------------------------------------------------------| ---------|
| child only     | child relatedness                                                     | sex + birth order + family size +  age + birth cohort + village  | a |
| mother only    | mother relatedness                                                    | same as above                                                        | b | 
| father only    | father relatedness                                                    | same as above                                                        | c |
| parents        | mother relatedness + father relatedness                               | same as above                                                        | d |
| all members    | child relatedness + mother relatedness + father relatedness (model 3) | same as above                                                        | e |
| residence pattern | household type (Neolocal vs Duolocal, Matrilocal and Patrilocal, model 2) | same as above                                                        | f |

SI Table \ref{tab:statsmodels}: hypotheses associated to causal models (note that the column 'Panel' indicates the panel in SI Figure \@ref(fig:cox), below, that reports the results relative to each regression). \label{tab:statsmodels}


Let's observe the grey dots in SI figure \@ref(fig:cox), where the large dots refer to the results from the datasets shown in figure \@ref(fig:dots), while the smear of smaller dots is given by 50 datasets simulated with different parameters. These represent parameter estimates of cox regression models for each causal model (listed as H1 to H4) estimated by the different cox regressions. Panel a) shows data relative to a model where we include only child relatedness as a predictor. Let's look at each hypothesis one at a time. In the first row we observe the estimated effect of child relatedness calculated on data simulated according to H1. Note that the simulation included _postitive_ effect of child relatedness on breastfeeding duration, so we would expect a negative effect, i.e. the more the child is related to the rest of the family, the longer will breastfeeding be. But if we include only child relatedness as a predictor, the negative effect of parents' relatedness overcomes that of child relatedness, and the parameter estimated will be positive: a counterintuitive result, but unavoidable given the connection between parents' and child's relatedness. Data simulated according to H2, where child relatedness has no direct effect, also produce an estimation that child relatedness will negatively affect breastfeeding duration. Once we move to H3 and H4, on the contrary, child relatedness has positive effect. Remeber that in both cases the data was simulated with a consistent positive effect of child relatedness, only including some effect for parents in H3 (positive for mother, negative for father) and no parental effect in H4. 
Let's move to panel b). Here we are looking at a model that estimates only the effect of maternal relatedness, and again, let's look at the grey dots. The model applied on data generated according to H1 correctly estimate a negative effect of maternal relatedness on duration, or a positive estimted parameter from the cox model. Similarly, H2 and H3 pick up on the positive effect of mom's relatedness, however they provide different effect sizes, even though the Poisson simulation used the same parameter. This is because in H3 there is also a positive effect of child relatedness, which correlates to maternal relatedness and hence is picked up by the model. Data generated according to H4 still produce a positive effect of maternal relatedness, even though there was none in the simulation: this is because maternal relatedness is connected to child relatedness, which in turn has positive effect on breastfeeding duration.
By this point it should be clear that simply interpreting the regression coefficients for these model will be unlikely to provide a reliable inference on the causal model generating the real data because of equifinality. Only the model including the three relatedness measures is able to recover the original relations between the factors (positive effect of child anf mother, negative of father). 

Moreover, then, we compare the results of all these six cox regressions on the real data to results obtained with data generated according to different causal models. We qualitatively compare the cox parameters estimted from the real data, shown by a light blue dot in panels a-c, and by lighter colors in panels d-f, to the estimates based on data simulated according to each causal model (H1-H4), shown in grey in panels a-c, in darker colors in panels d-f (note that the smear of points shows parameter estimates for 50 different simulations for which were used different sets of parameters, generated by sampling from a Gaussian distribution with mean 2 and SD 1 and multiplying according to the causal model, e.g.  $\beta = 4, \gamma = 2, \delta = -2$, for H3). We then qualitatively look at which of the casual models produces data that, once analyzed with the different cox models, _look the most like_ the real data _across_ the different statistical cox models. This allows to address equifinality issues beyond the correct estimates for the parameters.

The model including only child relatedness, in panel a), shows a positive effect of child relatedness (the cox parameter estimated is negative) for the real data and for H3 and H4, which suggests that H1 and H2 do not match the real data. The model that estimates only the effect of maternal relatedness, in panel b), shows a negative effect of maternal relatedness only in H1, while the real data, and H2-H4 are consistent with a positive effect of maternal relatedness on breastfeeding duration. Panel c) shows the results of a model including only father relatedness as a predictor. The real data, as well as hypotheses H1-H3 predict a negative effect of paternal relatedness (H4 was generated with no effect of paternal relatedness, but because child relatedness has a positive effect, if we include only father relatedness, this will appear to have a positive effect because it is correlated to child relatedness). If we include a predictor for each of the parent's relatedness, in panel d), we can look at the effect of each parent once we _control for the effect of the other parent's relatedness_. We can see that with the data generated according to H1, which posits a negative effect of both parents, the effect of their relatedness is markedly negative, while in the real data mother's effect is positive and father's effect is only slightly negative. H2 posits a marked negative effect of fathers (positive estimated parameter in the cox regression), and positive of mothers, which is what we observe in the real data, albeit with a smaller effect size. H3 generates a markedly positive effect of mother relatedness and close to zero effect for father relatedness, which is qualitatively similar to the results from the real data in this model. H4 produces a positive effect for both parents' relatedness (even though in the generative simulation we included no effect of parents, again, this is caused by the positive effect of child's relatedness, which is picked up by both parents). As indicated by the analysis of the DAG represented in SI Figure \@ref(fig:dag), the model including predictors for all members of the family is the one better able to disentangle the relative effects of each of their relatedness: it correctly picks up on the positive effect of child relatedness, in contrast to the negative effect of that of the parents in H1; it correctly estimates the effect of child relatedness close to zero, that of mother's relatedness to be positive, and father's relatedness to be negative, as generated by H2; it picks up on the positive effect of both child and mother's relatedness, with the former having a more positive effect, while fathers have a negative effect, for H3; and similarly positively correlates child relatedness to breastfeeding duration for data generated according to H4, while the parent's relatedness is close to zero. Comparing the results from the real data to those of the different models, H3 seems to generate data mode closely fitting to the real results. 

Summing up, while multiple causal models _could_ have generated results similar to those from the real data in some of the cox regression sets (i.e. equifinality), when all the models are observed together, and focusing on the linear model presented in panel e), model 3 from the main text, which includes predictors for all family members, H3 seems to be the causal model more closely matching the results obtained from the real data.




```{r cox, cache = TRUE, fig.cap = "Multiple plots showing parameters estimated by cox models run on the real data (light blue in a-c, light colors in d-f ), in comparison to similar models run on simulated data (each row in each model represents an hypothesis, larger grey/darker color dot is relative to one specific set of data, smear is from replication with 50 different parameter sets).",  fig.height=8, fig.fullwidth=TRUE }
#####real data


#some objects that are needed
N_attempted_pars <- 50 #n of different parameters to simulate with 
par_value <- rtruncnorm(N_attempted_pars, 0, mean = 2) #set of paramter values to simulate with 
avg_diff_coeff_fixed_pars <- matrix( NA, #matrix to store the mean difference between coefficients estimated by predictor set and hypothesis
                     nrow = 4, ncol = 12, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), 
                                                                         c("child only", "mother only", "father only", 
                                                                           "parents, mother", "parents, father",
                                                                           "all, child", "all, mother", "all, father",
                                                                           "residence, Matrilocal", "residence, Duolocal",  "residence, Patrilocal",
                                                                           "mean")))
PI5_diff_coeff_fixed_pars <- matrix( NA, #matrix to store the 
                     nrow = 4, ncol = 12, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), 
                                                                         c("child only", "mother only", "father only", 
                                                                           "parents, mother", "parents, father",
                                                                           "all, child", "all, mother", "all, father",
                                                                           "residence, Matrilocal", "residence, Duolocal",  "residence, Patrilocal",
                                                                           "mean")))
PI95_diff_coeff_fixed_pars <- matrix( NA, #matrix to store the mean difference between coefficients estimated by predictor set and hypothesis
                     nrow = 4, ncol = 12, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), 
                                                                         c("child only", "mother only", "father only", 
                                                                           "parents, mother", "parents, father",
                                                                           "all, child", "all, mother", "all, father",
                                                                           "residence, Matrilocal", "residence, Duolocal",  "residence, Patrilocal",
                                                                           "mean")))
store_coeffs <- matrix( NA, #matrix to store the coefficients,
                    nrow = 4, ncol = N_attempted_pars, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), NULL))

#plots simulation
par(mfrow = c(3,2),mgp = c(1.5, 0.5, 0), mar = c(2.5, 2.5, 2, 1) + 0.1)
#child only model
plot(c(bf$child_sim[[1]]$coefficients, bf$child_sim[[2]]$coefficients, bf$child_sim[[3]]$coefficients, bf$child_sim[[4]]$coefficients),1:4, pch = 16, cex = 2, col = col.alpha("grey40", 0.8), main = "a", xlab = "cox parameter estimate-child ", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(c(coeffs$child[1], coeffs$child[2], coeffs$child[3], coeffs$child[4]),1:4, pch = 16, col = col.alpha("grey40", 0.3))
        store_coeffs[,i] <- c(abs(as.numeric(coeffs$child[1]) - child_real$coefficients[1]), 
                              abs(as.numeric(coeffs$child[2]) - child_real$coefficients[1]), 
                              abs(as.numeric(coeffs$child[3]) - child_real$coefficients[1]), 
                              abs(as.numeric(coeffs$child[4]) - child_real$coefficients[1]))
}

avg_diff_coeff_fixed_pars[,1] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,1] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,1] <- apply(store_coeffs, 1, PI)[2,]

points(rep(child_real$coefficients[1], 4),1:4, pch = 16, cex = 2, col = col.alpha("cornflowerblue", 0.8))
legend("topleft", inset = 0.02, c("Child, simulated", "Child, real data"), fill = c("grey40", "cornflowerblue"), border = c("grey40", "cornflowerblue"), box.col = "white")

#mother
plot(c(bf$mother_sim[[1]]$coefficients, bf$mother_sim[[2]]$coefficients, bf$mother_sim[[3]]$coefficients, bf$mother_sim[[4]]$coefficients),1:4, pch = 16, cex = 2, col = col.alpha("grey40", 0.8), main = "b", xlab = "cox parameter estimate-mother", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(c(coeffs$mother[1], coeffs$mother[2], coeffs$mother[3], coeffs$mother[4]),1:4, pch = 16, col = col.alpha("grey40", 0.3))
        store_coeffs[,i] <- c(abs(as.numeric(coeffs$mother[1]) - mother_real$coefficients[1]), 
                              abs(as.numeric(coeffs$mother[2]) - mother_real$coefficients[1]), 
                              abs(as.numeric(coeffs$mother[3]) - mother_real$coefficients[1]), 
                              abs(as.numeric(coeffs$mother[4]) - mother_real$coefficients[1]))
}

avg_diff_coeff_fixed_pars[,"mother only"] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,"mother only"] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"mother only"] <- apply(store_coeffs, 1, PI)[2,]

points(rep(mother_real$coefficients[1], 4),1:4, pch = 16, cex = 2, col = col.alpha("cornflowerblue", 0.8))
legend("topleft", inset = 0.02,  c("Mother, simulated", "Mother, real data"), fill = c("grey40", "cornflowerblue"), border = c("grey40", "cornflowerblue"), box.col = "white")

#father
plot(c(bf$father_sim[[1]]$coefficients, bf$father_sim[[2]]$coefficients, bf$father_sim[[3]]$coefficients, bf$father_sim[[4]]$coefficients),1:4, pch = 16, cex = 2, col = col.alpha("grey40", 0.8), main = "c", xlab = "cox parameter estimate-father", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(c(coeffs$father[1], coeffs$father[2], coeffs$father[3], coeffs$father[4]),1:4, pch = 16, col = col.alpha("grey40", 0.3))
        store_coeffs[,i] <- c(abs(as.numeric(coeffs$father[1]) - father_real$coefficients[1]), 
                              abs(as.numeric(coeffs$father[2]) - father_real$coefficients[1]), 
                              abs(as.numeric(coeffs$father[3]) - father_real$coefficients[1]), 
                              abs(as.numeric(coeffs$father[4]) - father_real$coefficients[1]))
}

avg_diff_coeff_fixed_pars[,"father only"] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,"father only"] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"father only"] <- apply(store_coeffs, 1, PI)[2,]

points(rep(father_real$coefficients[1], 4),1:4, pch = 16, cex = 2, col = col.alpha("cornflowerblue", 0.8))
legend("topright", inset = 0.02, c("Father, simulated", "Father, real data"), fill = c("grey40", "cornflowerblue"), border = c("grey40", "cornflowerblue"), box.col = "white")

#both parents
store_coeffs_2 <- matrix( NA, #matrix to store the coefficients, second set to keep fathers' stuff
                    nrow = 4, ncol = N_attempted_pars, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), NULL))

plot(c(bf$parents_sim[[1]]$coefficients, bf$parents_sim[[2]]$coefficients, bf$parents_sim[[3]]$coefficients, bf$parents_sim[[4]]$coefficients),rep(1:4, each = 2) + c(-0.1, 0.1), pch = 16, cex = 2, col = c("darkred", "darkblue"), main = "d", xlab = "cox parameter estimate-parents", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(unlist(c(coeffs$parents[1], coeffs$parents[2], coeffs$parents[3], coeffs$parents[4])),rep(1:4, each = 2) + c(-0.1, 0.1), pch = 16, col = adjustcolor(c("darkred", "darkblue"), alpha.f=0.4))
        store_coeffs[,i] <- c(abs(coeffs$parents[[1]][[1]] - parents_real$coefficients[1]), 
                              abs(coeffs$parents[[2]][[1]] - parents_real$coefficients[1]), 
                              abs(coeffs$parents[[3]][[1]] - parents_real$coefficients[1]), 
                              abs(coeffs$parents[[4]][[1]] - parents_real$coefficients[1]))
        store_coeffs_2[,i] <- c(abs(coeffs$parents[[1]][[2]] - parents_real$coefficients[2]), 
                              abs(coeffs$parents[[2]][[2]] - parents_real$coefficients[2]), 
                              abs(coeffs$parents[[3]][[2]] - parents_real$coefficients[2]), 
                              abs(coeffs$parents[[4]][[2]] - parents_real$coefficients[2]))
}

avg_diff_coeff_fixed_pars[,"parents, mother"] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,"parents, mother"] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"parents, mother"] <- apply(store_coeffs, 1, PI)[2,]
avg_diff_coeff_fixed_pars[,"parents, father"] <- apply(store_coeffs_2, 1, mean)
PI5_diff_coeff_fixed_pars[,"parents, father"] <- apply(store_coeffs_2, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"parents, father"] <- apply(store_coeffs_2, 1, PI)[2,]

points(rep(parents_real$coefficients[1:2], 4),rep(1:4, each = 2) + c(-0.1, 0.1), pch = 16, cex = 2, col = c("indianred", "cornflowerblue"))
legend("topleft", inset = 0.02, c("Mother", "Father"), fill = c("indianred", "cornflowerblue"), border = c( "indianred", "cornflowerblue"), box.col = "white")

#all family members
store_coeffs_3 <- matrix( NA, #matrix to store the coefficients, second set to keep fathers' stuff
                    nrow = 4, ncol = N_attempted_pars, byrow = FALSE, dimnames = list(c("H1", "H2", "H3", "H4"), NULL))

plot(c(bf$all_sim[[1]]$coefficients, bf$all_sim[[2]]$coefficients, bf$all_sim[[3]]$coefficients, bf$all_sim[[4]]$coefficients),rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, cex = 2, col = c("darkgreen", "darkred", "darkblue"), main = "e", xlab = "cox parameter estimate by family member", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(unlist(c(coeffs$all[1], coeffs$all[2], coeffs$all[3], coeffs$all[4])), rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, col = adjustcolor(c("darkgreen","darkred", "darkblue"), alpha.f=0.4))
        store_coeffs[,i] <- c(abs(coeffs$all[[1]][[1]] - all_real$coefficients[1]), 
                              abs(coeffs$all[[2]][[1]] - all_real$coefficients[1]), 
                              abs(coeffs$all[[3]][[1]] - all_real$coefficients[1]), 
                              abs(coeffs$all[[4]][[1]] - all_real$coefficients[1]))
        store_coeffs_2[,i] <- c(abs(coeffs$all[[1]][[2]] - all_real$coefficients[2]), 
                              abs(coeffs$all[[2]][[2]] - all_real$coefficients[2]), 
                              abs(coeffs$all[[3]][[2]] - all_real$coefficients[2]), 
                              abs(coeffs$all[[4]][[2]] - all_real$coefficients[2]))
        store_coeffs_3[,i] <- c(abs(coeffs$all[[1]][[3]] - all_real$coefficients[3]), 
                              abs(coeffs$all[[2]][[3]] - all_real$coefficients[3]), 
                              abs(coeffs$all[[3]][[3]] - all_real$coefficients[3]), 
                              abs(coeffs$all[[4]][[3]] - all_real$coefficients[3]))
}

avg_diff_coeff_fixed_pars[,"all, child"] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,"all, child"] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"all, child"] <- apply(store_coeffs, 1, PI)[2,]
avg_diff_coeff_fixed_pars[,"all, mother"] <- apply(store_coeffs_2, 1, mean)
PI5_diff_coeff_fixed_pars[,"all, mother"] <- apply(store_coeffs_2, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"all, mother"] <- apply(store_coeffs_2, 1, PI)[2,]
avg_diff_coeff_fixed_pars[,"all, father"] <- apply(store_coeffs_3, 1, mean)
PI5_diff_coeff_fixed_pars[,"all, father"] <- apply(store_coeffs_3, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"all, father"] <- apply(store_coeffs_3, 1, PI)[2,]

points(rep(all_real$coefficients[1:3], 4),rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, cex = 2, col = c("lightgreen","indianred", "cornflowerblue"))
legend("topleft", inset = 0.02, c("Child", "Mother", "Father"), fill = c("lightgreen", "indianred", "cornflowerblue"), border = c("lightgreen", "indianred", "cornflowerblue"), box.col = "white")

#residence type
plot(c(bf$residence_sim[[1]]$coefficients, bf$residence_sim[[2]]$coefficients, bf$residence_sim[[3]]$coefficients, bf$residence_sim[[4]]$coefficients),rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, cex = 2, col = c("darkgreen", "darkred", "darkblue"), main = "f", xlab = "cox parameter estimate by residence type", ylab = "", yaxt = "n" , ylim = rev(c(0.5, 4.5)))
abline( v = 0 , col = "grey80")
axis(2, at = 1:4, las=1,
     labels =  c("H1", "H2", "H3", "H4"))
for (i in 1:length(par_value)) {
        many_poiss_par <- matrix(c( 3,  par_value[i],-par_value[i],-par_value[i], #H1
                             0.7, 0, par_value[i],-par_value[i], #H2
                             -2.5, 2*par_value[i],par_value[i],-par_value[i], #H3
                             0.2, par_value[i], 0, 0),#H4
                     nrow = 4, ncol = n_hypotheses, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = many_poiss_par)
        points(unlist(c(coeffs$residence[1], coeffs$residence[2], coeffs$residence[3], coeffs$residence[4])),rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, col = adjustcolor(c("darkgreen", "darkred", "darkblue"), alpha.f=0.4))
        store_coeffs[,i] <- c(abs(coeffs$residence[[1]][[1]] - residence_real$coefficients[1]), 
                              abs(coeffs$residence[[2]][[1]] - residence_real$coefficients[1]), 
                              abs(coeffs$residence[[3]][[1]] - residence_real$coefficients[1]), 
                              abs(coeffs$residence[[4]][[1]] - residence_real$coefficients[1]))
        store_coeffs_2[,i] <- c(abs(coeffs$residence[[1]][[2]] - residence_real$coefficients[2]), 
                              abs(coeffs$residence[[2]][[2]] - residence_real$coefficients[2]), 
                              abs(coeffs$residence[[3]][[2]] - residence_real$coefficients[2]), 
                              abs(coeffs$residence[[4]][[2]] - residence_real$coefficients[2]))
        store_coeffs_3[,i] <- c(abs(coeffs$residence[[1]][[3]] - residence_real$coefficients[3]), 
                              abs(coeffs$residence[[2]][[3]] - residence_real$coefficients[3]), 
                              abs(coeffs$residence[[3]][[3]] - residence_real$coefficients[3]), 
                              abs(coeffs$residence[[4]][[3]] - residence_real$coefficients[3]))
}

avg_diff_coeff_fixed_pars[,"residence, Duolocal"] <- apply(store_coeffs, 1, mean)
PI5_diff_coeff_fixed_pars[,"residence, Duolocal"] <- apply(store_coeffs, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"residence, Duolocal"] <- apply(store_coeffs, 1, PI)[2,]
avg_diff_coeff_fixed_pars[,"residence, Matrilocal"] <- apply(store_coeffs_2, 1, mean)
PI5_diff_coeff_fixed_pars[,"residence, Matrilocal"] <- apply(store_coeffs_2, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"residence, Matrilocal"] <- apply(store_coeffs_2, 1, PI)[2,]
avg_diff_coeff_fixed_pars[,"residence, Patrilocal"] <- apply(store_coeffs_3, 1, mean)
PI5_diff_coeff_fixed_pars[,"residence, Patrilocal"] <- apply(store_coeffs_3, 1, PI)[1,]
PI95_diff_coeff_fixed_pars[,"residence, Patrilocal"] <- apply(store_coeffs_3, 1, PI)[2,]
points(rep(residence_real$coefficients[1:3], 4),rep(1:4, each = 3) + c(-0.15, 0, 0.15), pch = 16, cex = 2, col = c("lightgreen", "indianred",  "lightblue"))
legend("topleft", inset = 0.02, c( "Duolocal", "Matrilocal",  "Patrilocal"), fill = c( "lightgreen", "indianred", "lightblue"), border = c( "lightgreen", "indianred", "lightblue"), box.col = "white")
#1 duolocal
#2 matrilocal
#3 neolocal
#4 patrilocal

for (i in 1:4) {
  avg_diff_coeff_fixed_pars[i,"mean"] <- mean(avg_diff_coeff_fixed_pars[i,1:11])
}
```


<!-- #Table \ref{tab:diffs_pars_hyp} reports the average difference between the coefficient estimated by cox models run on the real data and coefficients estimated by cox models run on 50 different simulations per each causal model. REPORT RESULT -->

<!-- ```{r table_differences_pars_hypotheses} -->

<!-- kable(avg_diff_coeff_fixed_pars, "pipe", digits = 2) -->
<!-- ``` -->

<!-- SI Table \ref{tab:diffs_pars_hyp}: Average difference between the coefficient estimates by cox models applied on the real data, and cox models applied on 50 sets of data generated according to each causal model (H1-H4). \label{tab:diffs_pars_hyp} -->

### Estimate the parameter set most closely matching the real data

A second contribution to inference can come from a search in the parameter space for a combination of parameters that more closely match the results from the real data. To do so, we simulate 500 datasets from a random set of parameters where the intercept, the parameter for child's and parent's relatedness are sampled from a Gaussian distribution with mean 0 and SD 3. We calculate the mean difference between the coefficients estimated from the real data and the coefficients estimated from each dataset for the different cox models (described in table \ref{tab:statsmodels}), and select the set of parameters with the best match to the real data. We repeat the process 250 times, and calculate the mean value of these parameters, as well as the 5th and 95th percentiles. These are reported in table \ref{tab:find_generative_parameters}.

```{r find_generative_parameters, cache=TRUE }
n_sims <- 250
best_pars <- matrix( 0,
                     nrow = 4, ncol = n_sims, byrow = FALSE, dimnames = list(c("intercept", "child", "mother", "father"), NULL))
for (i in 1:n_sims) {
  best_diff <- 1000
  for (j in 1:500) {
         best_poiss_par <- matrix(c( rnorm(1, 0, 3), #intercept
                             rnorm(1, 0, 3), #child
                             rnorm(1, 0, 3), #mother
                             rnorm(1, 0, 3)),#father
                     nrow = 4, ncol = 1, byrow = FALSE)
        coeffs <- sim_breastfeeding(100, coefficients = TRUE, poiss_pars = best_poiss_par)
        avg_diff_coeff <- (abs(as.numeric(coeffs[[1]]) - child_real$coefficients[1]) + 
                           abs(as.numeric(coeffs[[2]]) - mother_real$coefficients[1]) +
                           abs(as.numeric(coeffs[[3]]) - father_real$coefficients[1]) +
                           abs(as.numeric(coeffs[["parents"]][[1]][1]) - parents_real$coefficients[1]) +
                           abs(as.numeric(coeffs[["parents"]][[1]][2]) - parents_real$coefficients[2])  +
                           abs(as.numeric(coeffs[["all"]][[1]][1]) - all_real$coefficients[1]) +
                           abs(as.numeric(coeffs[["all"]][[1]][2]) - all_real$coefficients[2]) +
                           abs(as.numeric(coeffs[["all"]][[1]][3]) - all_real$coefficients[3]) +
                           abs(as.numeric(coeffs[["residence"]][[1]][1]) - residence_real$coefficients[1])  +
                           abs(as.numeric(coeffs[["residence"]][[1]][2]) - residence_real$coefficients[2])  +
                           abs(as.numeric(coeffs[["residence"]][[1]][3]) - residence_real$coefficients[3])  ) / 11
        if(best_diff > avg_diff_coeff) {
            best_diff <- avg_diff_coeff
            best_pars[,i] <- best_poiss_par
        }
       } #j
} #i

mean_parameters <- apply(best_pars, 1, mean)
PI_parameters <- apply(best_pars, 1, PI)

kable(rbind(mean_parameters, PI_parameters), "pipe", digits = 2)
```

SI Table \ref{tab:find_generative_parameters}: Best fitting parameters for each family member.\label{tab:find_generative_parameters}

As we can see, the parameters generating data whose results in a cox model are the most similar to the real data indicate a similarly positive effect for child and maternal relatedness, and a mostly negative effect for paternal relatedness, which is coherent with the predictions of H3.

